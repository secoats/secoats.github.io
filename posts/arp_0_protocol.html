<!DOCTYPE html>
<html lang="en">
    <head>
        <title>secoats | Fun with ARP - A Look at the Protocol</title>
        <link rel="canonical" href="https://secoats.github.io/posts/arp_0_protocol.html" />
        <link rel="stylesheet" href="/assets/css/main.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&family=Roboto:wght@400;700&family=Noto+Sans&display=swap" rel="stylesheet" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="google-site-verification" content="ec3XZVmgp3ZOsiLB8riLA-9B5kVJVR_71u11vmIMs4w" />
        <meta name="description" content="Ramblings about InfoSec, Pentesting, CTF and Tools" />
        <meta property="og:type" content="article" />
        <meta property="og:locale" content="en_US" />
        <meta property="og:site_name" content="secoats" />
        <meta property="og:title" content="Fun with ARP - A Look at the Protocol" />
        <meta property="og:url" content="https://secoats.github.io/posts/arp_0_protocol.html" />
        <meta property="og:image" content="https://secoats.github.io/assets/img/oats_field.jpg">
        <meta name="author" content="secoats">
        <meta property="article:author" content="secoats">
    </head>
    <body>
        <div id="main">
            <div id="header">
                <div id="masthead" class="wrapper">
                    <span class="site-title">
                        <a href="/">secoats</a>
                    </span>
                    <span class="main-nav">
                        <a href="/posts.html">Posts</a>
<a href="/categories.html#writeup">Writeups</a>
<a href="/categories.html#tutorial">Tutorials</a>
                    </span>
                </div>
            </div>
            <main id="content" class="wrapper">
                <article class="mbox">
                    
                    <h1 class="article-headline">Fun with ARP - A Look at the Protocol</h1>
                    <p class="article-subline">
                        <span class="article-meta-reading-time"><i class="far fa-clock" aria-hidden="true"></i> 19 minute read</span> - <span class="article-meta-published">January 24, 2022</span>
                    </p>
                    <p>The <strong>Address Resolution Protocol (ARP)</strong> (<a href="https://datatracker.ietf.org/doc/html/rfc826">RFC 826; 1982</a>) is an essential part of the TCP/IP protocol suite and will remain in common use as long as IPv4 sticks around. It is a very simple protocol and fun to hack with.</p>
<p>In modern times ARP is most commonly used to figure out which MAC address (hardware address) is associated with a given IPv4 address (logical address) in an Ethernet network segment.</p>
<p>In such a network every host keeps an ARP table. This table stores the known pairs of MAC and IPv4 addresses for neighboring hosts.</p>
<h2 id="table-of-content">Table of Content<a class="headerlink" href="#table-of-content" title="Permanent link"> </a></h2>
<ul>
<li><a href="#simple-example">Simple Example</a></li>
<li><a href="#no-security">No Security</a></li>
<li><a href="#implementation-differences">Implementation Differences</a></li>
<li><a href="#getting-practical">Getting Practical</a><ul>
<li><a href="#byte-tables">Byte Tables</a></li>
<li><a href="#logging-ethernet-and-arp">Logging Ethernet and ARP (Python)</a></li>
<li><a href="#arp-in-action">ARP in Action</a></li>
</ul>
</li>
<li><a href="#arp-announcements-and-probes">ARP Announcements and Probes</a></li>
<li><a href="#arp-table-update-behavior">ARP Table Update Behavior (OS specific)</a></li>
<li><a href="#reference-commands-for-testing-with-arp">Reference: Commands for Testing with ARP</a></li>
<li><a href="#reference-arp-terminology-glossary">Reference: ARP Terminology Glossary</a></li>
</ul>
<h2 id="simple-example">Simple Example<a class="headerlink" href="#simple-example" title="Permanent link"> </a></h2>
<p>Print ARP table on Linux:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code><span class="c1"># On host "Alf"</span>
<span class="c1"># MAC: 08-00-27-aa-aa-aa</span>
<span class="c1"># IPv4: 10.0.0.1</span>
root@alf:~$ arp -a
? <span class="o">(</span><span class="m">10</span>.0.0.111<span class="o">)</span> at <span class="m">08</span>:00:27:cc:cc:cc <span class="o">[</span>ether<span class="o">]</span> on eth0
</code></pre></div></div></div>
<p>Print ARP table on Windows (cmd):</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code><span class="c1"># On Host "Bert"</span>
<span class="c1"># MAC: 08-00-27-aa-aa-aa</span>
<span class="c1"># IPv4: 10.0.0.2</span>
C:<span class="se">\U</span>sers<span class="se">\B</span>ert&gt; arp -a

Interface: <span class="m">10</span>.0.0.2 --- 0x7
  Internet Address    Physical Address     Type
  <span class="m">10</span>.0.0.111          <span class="m">08</span>:00:27:cc:cc:cc    dynamic
  <span class="m">10</span>.0.0.255          ff-ff-ff-ff-ff-ff    static
  <span class="m">255</span>.255.255.255     ff-ff-ff-ff-ff-ff    static
</code></pre></div></div></div>
<p>In this example both hosts have a common gateway router with IPv4 address <code>10.0.0.111</code> and MAC address <code>08:00:27:cc:cc:cc</code>.</p>
<p>Let us assume we are in an Ethernet-based local network with several hosts connected via a switch or hub. All hosts in that Ethernet are in the same logical IPv4 network <code>10.0.0.0/24</code> and no routing is required in this example.</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Example Network" src="/assets/img/network_example_simple2.png"/></div></div></p>
<p>When host Alf (<code>10.0.0.1</code>) wants to communicate with host Bert (<code>10.0.0.2</code>), then host Alf will first have to figure out the MAC address of host Bert. Otherwise host Alf would not know where to send its Ethernet frames.</p>
<p>Host Alf will first look into its own ARP table to see if it already knows the MAC address associated with the IPV4 address "10.0.0.2". If it already has an entry, then the info can be used directly and the ARP process ends here.</p>
<p>If there is no entry, then host Alf will ask the entire local network: "Which host has IPv4 address 10.0.0.2?"</p>
<p>This <strong>ARP Request</strong> will be sent as the payload of an Ethernet frame. The target MAC Address of this frame will be the broadcast address <code>ff:ff:ff:ff:ff:ff</code>. This means the frame is addressed to all hosts in the same LAN segment. All of those hosts should receive it.</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>[ Ethernet Frame: Source: 08-00-27-aa-aa-aa; Destination: ff-ff-ff-ff-ff-ff; Content: ARP (0x806) ]
    -----------------------------------------------
    | ARP REQUEST                                 |
    -----------------------------------------------
    | HTYPE 0x1 | PTYPE 0x800 | HLEN 6 | PLEN 4   |
    | SHA  08-00-27-aa-aa-aa  | SPA  10.0.0.1     |
    | THA  00-00-00-00-00-00  | TPA  10.0.0.2     |
    -----------------------------------------------
</code></pre></div></div></div>
<ul>
<li>HTYPE - Hardware type (0x1 = Ethernet)</li>
<li>PTYPE - Protocol Type (0x800 = Ipv4)</li>
<li>HLEN - Hardware address length (6 Bytes for MAC Address)</li>
<li>PLEN - Protocol address length (4 Bytes for IPv4 Address)</li>
<li>SHA - Sender hardware address (08-00-27-aa-aa-aa)</li>
<li>SPA - Sender protocol address (10.0.0.1)</li>
<li>THA - Target hardware address (00-00-00-00-00-00 because it is unknown)</li>
<li>TPA - Target protocol address (10.0.0.2)</li>
</ul>
<p>If everything goes well, then Bert will receive this ARP Request and send an <strong>ARP Reply</strong> along the lines of: "I have IPv4 address 10.0.0.2 and here is my MAC address". This Reply Ethernet frame will be directed directly at the MAC Address of Alf (unicast).</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>[ Ethernet Frame: Source: 08-00-27-bb-bb-bb; Dest: 08-00-27-aa-aa-aa; Content: ARP (0x806) ]
    -----------------------------------------------
    | ARP REPLY                                   |
    -----------------------------------------------
    | HTYPE 0x1 | PTYPE 0x800 | HLEN 6 | PLEN 4   |
    | SHA  08-00-27-bb-bb-bb  | SPA  10.0.0.2     |
    | THA  08-00-27-aa-aa-aa  | TPA  10.0.0.1     |
    -----------------------------------------------
</code></pre></div></div></div>
<p>Alf will receive this Reply and update its ARP table accordingly:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>root@alf:~$ arp -a
? <span class="o">(</span><span class="m">10</span>.0.0.111<span class="o">)</span> at <span class="m">08</span>:00:27:cc:cc:cc <span class="o">[</span>ether<span class="o">]</span> on eth0
? <span class="o">(</span><span class="m">10</span>.0.0.2<span class="o">)</span> at <span class="m">08</span>:00:27:bb:bb:bb <span class="o">[</span>ether<span class="o">]</span> on eth0
</code></pre></div></div></div>
<p>Afterwards Alf can now communicate with <code>10.0.0.2</code> (Bert).</p>
<p>In the example above <strong>Bert will usually also add or update an entry for Alf in its own ARP table when it receives Alf's ARP Request</strong>. Using the sender hardware (SHA) and protocol (SPA) addresses in the Request. </p>
<p>So one ARP handshake tends to updates the tables of both hosts. Otherwise Bert would have to send out its own ARP Request in order to figure out the MAC address associated with <code>10.0.0.1</code> (Alf). Which would create unnecessary network traffic.</p>
<h2 id="no-security">No Security<a class="headerlink" href="#no-security" title="Permanent link"> </a></h2>
<p>You might have noticed that in this process there is no mechanism that would ensure that the host that answers Alf's request is actually Bert and not some imposter. And you are right, there is none.</p>
<p>Similarly you can also usually <strong>update the tables of other hosts</strong> simply by <strong>sending them an ARP Request</strong>. In that Request you can pretend to speak for any IPv4 address. This will usually also overwrite any existing dynamic ARP table entries for that IPv4 address.</p>
<p>Depending on the implementation of ARP, an <strong>unsolicited ARP Reply</strong> might have the same effect. "Unsolicited" means the target host never sent out an ARP Request that would warrant the ARP Reply. From my experience most Linux distributions usually ignore unsolicited Reply messages. Same with modern Windows versions. But the pfSense (FreeBSD) VM used below did accept them and updated their table accordingly.</p>
<p>The two methods mentioned above are commonly exploited in the form of <strong>man-in-the-middle attacks</strong>, usually referred to as <strong>"ARP Spoofing"</strong> or "ARP cache poisoning". For example this can be used to read unencrypted network traffic, exploit trust relationships based on IP addresses or denial of service (DoS).</p>
<p>There are some defense strategies to address this. </p>
<p>One strategy is to <strong>manually set static ARP entries</strong> in the ARP tables of all the hosts and disabling the dynamic ARP Reply/Response system. This obviously defeats the whole point of ARP and quite often leads to unsustainable administrative effort. In very small network segments that rarely change this might be a good idea though.</p>
<p>Other strategies involve <strong>automatic detection systems</strong> for suspicious ARP activity. For example <a href="https://en.wikipedia.org/wiki/Arpwatch">arpwatch</a> or <a href="https://en.wikipedia.org/wiki/ArpON">ArpON</a> to name some free ones.</p>
<p>When you <strong>manually look</strong> for indications of spoofing, then an obvious hint is the existence of <strong>several IPv4 addresses associated with the same MAC address</strong>. This must not <em>necessarily</em> mean there is spoofing going on, but it is a pretty good indicator. An easy way for an attacker to circumvent this is to use a fictional MAC address for spoofing and relaying. Alternatively an attacker could deactivate dynamic ARP on their host before connecting to the network. They could also just wait for existing ARP entries to time out before starting the spoofing after deactivating dynamic ARP.</p>
<h2 id="implementation-differences">Implementation Differences<a class="headerlink" href="#implementation-differences" title="Permanent link"> </a></h2>
<p>Besides the Request/Reply handshake and the existence of an ARP table, the specification of the protocol (<a href="https://datatracker.ietf.org/doc/html/rfc826">RFC 826; 1982</a>) leaves a lot of room for custom implementations.</p>
<p>Depending on the implementation, the entries of the ARP table are usually only considered valid or trustworthy for a limited amount of time. After some time they will get removed or are considered stale. In newer Windows versions this time is usually somewhere between 15 to 45 seconds (random factor is involved).</p>
<p>In some implementations entries might get refreshed automatically in regular intervals. For that the host will send regular ARP requests to the known neighbors in the table. The Ethernet frames of those ARP Requests will be addressed directly to the known MAC address of the neighbor in the ARP table, rather than using a broadcast MAC address. Depending on the answer (or the lack thereof) the local ARP table will be updated. </p>
<p>The RFC 826 discusses these design decisions in the "Related issue" section at the bottom of the document.</p>
<h2 id="getting-practical">Getting Practical<a class="headerlink" href="#getting-practical" title="Permanent link"> </a></h2>
<p>Let us take a more practical look at ARP. I have created some VM's with different OS' in VirtualBox and assigned them to the same internal network.</p>
<p>If you want to follow along you can of course re-use some VMs you already have.</p>
<p>I mirrored the example above, plus I added a Kali VM that I will use to test the behavior of the other VMs:</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Network Lab" src="/assets/img/arp_vms.png"/></div></div></p>
<ul>
<li><strong>Alf</strong> (<a href="https://www.debian.org/download">Debian Linux 11</a>) - <code>08:00:27:AA:AA:AA</code> - <code>10.0.0.1 /24</code></li>
<li><strong>Bert</strong> (<a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">Windows 11</a>) - <code>08:00:27:BB:BB:BB</code> - <code>10.0.0.2 /24</code></li>
<li><strong>Middleman</strong> (<a href="https://www.kali.org/get-kali/">Kali Linux</a> or some other Linux distro) - <code>08:00:27:DD:DD:DD</code> - <code>10.0.0.42 /24</code></li>
<li><strong>Gateway</strong> (<a href="https://www.pfsense.org/">pfSense FreeBSD</a>) - <code>08:00:27:CC:CC:CC</code> - <code>10.0.0.111 /24</code></li>
</ul>
<p>You can add them to a shared internal network and change the MAC addresses in the network config of the VMs.</p>
<p>I named my shared internal network "arp_net":</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Alf Adapter config" src="/assets/img/arp_network_config.png"/></div></div></p>
<p>Configure Bert and Middleman like this as well.</p>
<p>I assume you know how to install the operating systems and set a static IPv4 address inside of those VMs. I assigned them IPv4 addresses as listed above and configured <code>10.0.0.111</code> as the default gateway.</p>
<p>For the pfSense router I created two network interfaces. One in the internal network configured as listed above (08:00:27:CC:CC:CC - 10.0.0.111), the other interface being set to "Bridged Adapter" mode. </p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Gateway Adapter config" src="/assets/img/gateway_network_config.png"/></div></div></p>
<p>When you configure pfSense via terminal, set the bridged adapter as the WAN interface. You should probably change the password of the web interface or disable it.</p>
<h3 id="byte-tables">Byte Tables<a class="headerlink" href="#byte-tables" title="Permanent link"> </a></h3>
<p>Here are the byte tables for ARP and Ethernet frames:</p>
<table class="protocol">
<thead>
<th class="table-header" colspan="5">Ethernet II Frame</th>
</thead>
<thead>
<th>MAC Destination</th>
<th>MAC Source</th>
<th>Ethertype</th>
<th style="background-color: #999;">Payload</th>
<th>Frame Check 32‑bit CRC</th>
</thead>
<tr>
<td>6 Bytes</td>
<td>6 Bytes</td>
<td>2 Bytes</td>
<td style="background-color: #ccc;">46‑1500 Bytes</td>
<td>4 Bytes</td>
</tr>
</table>
<p><strong>ARP</strong> for Ethernet and Ipv4 is very small and <strong>will only take up 28 bytes of the frame payload section</strong>. The minimum frame payload size is 46 bytes though. This means the remaining 18 bytes of the payload section will be padded with zeroed bytes (0x00) or junk data.</p>
<table class="protocol">
<thead>
<th class="table-header" colspan="4">Address Resolution Protocol (ARP)</th>
</thead>
</table>
<table class="protocol">
<thead>
<th style="background-color:#48a2ccaa;">Byte 0</th>
<th style="background-color:#48a2ccaa;">Byte 1</th>
</thead>
<tr>
<td colspan="2" style="background-color:#7dcbf0aa;"><b>Hardware type (HTYPE)</b> <br/>[expected: 0x2 for Ethernet]</td>
</tr>
</table>
<table class="protocol">
<thead>
<th style="background-color:#82a451aa;">Byte 2</th>
<th style="background-color:#82a451aa;">Byte 3</th>
</thead>
<tr>
<td colspan="2" style="background-color:#b9c6a6aa;"><b>Protocol type (PTYPE)</b> <br/>[expected: 0x800 for Ipv4]</td>
</tr>
</table>
<table class="protocol">
<thead>
<th style="background-color:#48a2ccaa;">Byte 4</th>
<th style="background-color:#82a451aa;">Byte 5</th>
</thead>
<tr>
<td style="background-color:#7dcbf0aa;"><b>Hardware address length (HLEN)</b> <br/>[expected: 0x6]</td>
<td style="background-color:#b9c6a6aa;"><b>Protocol address length (PLEN)</b> <br/>[expected: 0x4]</td>
</tr>
</table>
<table class="protocol">
<thead>
<th>Byte 6</th>
<th>Byte 7</th>
</thead>
<tr>
<td colspan="2"><b>Operation (OPER)</b> <br/>[0x1 = Request; 0x2 = Reply]</td>
</tr>
</table>
<table class="protocol">
<thead>
<th style="background-color:#48a2ccaa;">Byte 8 - Byte 13 (~6 bytes)</th>
</thead>
<tr>
<td style="background-color:#7dcbf0aa;">Sender hardware address (SHA)</td>
</tr>
</table>
<table class="protocol">
<thead>
<th style="background-color:#48a2ccaa;">Byte 14 - Byte 17 (~4 bytes)</th>
</thead>
<tr>
<td style="background-color:#7dcbf0aa;">Sender protocol address (SPA)</td>
</tr>
</table>
<table class="protocol">
<thead>
<th style="background-color:#82a451aa;">Byte 18 - Byte 23 (~6 bytes)</th>
</thead>
<tr>
<td style="background-color:#b9c6a6aa;">Target hardware address (THA)</td>
</tr>
</table>
<table class="protocol">
<thead>
<th style="background-color:#82a451aa;">Byte 24 - Byte 27 (~4 bytes)</th>
</thead>
<tr>
<td style="background-color:#b9c6a6aa;">Target protocol address (TPA)</td>
</tr>
</table>
<p>The first 8 bytes of the ARP message are static in length. They are followed by the address section.</p>
<p>The address section <strong>can differ in length based on the values of HLEN and PLEN</strong>. </p>
<p>But in the expected use case with MAC addresses and IPv4 addresses it will be 6 bytes and 4 bytes respectively for Sender and Target.</p>
<h3 id="logging-ethernet-and-arp">Logging Ethernet and ARP<a class="headerlink" href="#logging-ethernet-and-arp" title="Permanent link"> </a></h3>
<p>You can of course log ARP in <a href="https://www.tcpdump.org/manpages/tcpdump.1.html">tcpdump</a> or <a href="https://www.wireshark.org/">Wireshark</a>.</p>
<p>But I will re-use some code that I used for <a href="https://secoats.github.io/posts/ethernet_sniffer.html">my blog post about writing a network sniffer from scratch</a>. If you require more details about the libraries and network constants that I am going to use, then check out that article.</p>
<p>This code will also be used in the next part of this series about ARP Spoofing.</p>
<p>I hacked together this listener for ARP and the Ethernet frames that transport it:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># 0A75</span>
<span class="c1"># arpfun.py</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">ETHER_TYPE_DICT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x0800</span><span class="p">:</span> <span class="s2">"Internet Protocol version 4 (IPv4)"</span><span class="p">,</span>
    <span class="mh">0x0806</span><span class="p">:</span> <span class="s2">"Address Resolution Protocol (ARP)"</span><span class="p">,</span>
    <span class="mh">0x86DD</span><span class="p">:</span> <span class="s2">"Internet Protocol Version 6 (IPv6)"</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ETHER_TYPE_DICT_INVERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"IPv4"</span><span class="p">:</span> <span class="mh">0x0800</span><span class="p">,</span>
    <span class="s2">"ARP"</span><span class="p">:</span> <span class="mh">0x0806</span><span class="p">,</span>
    <span class="s2">"IPv6"</span><span class="p">:</span> <span class="mh">0x86DD</span>
<span class="p">}</span>

<span class="n">ARP_OPERATION_DICT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"REQUEST"</span><span class="p">:</span> <span class="mh">0x01</span><span class="p">,</span>
    <span class="s2">"REPLY"</span><span class="p">:</span> <span class="mh">0x02</span>
<span class="p">}</span>

<span class="n">ARP_HTYPE_DICT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"ETHERNET"</span><span class="p">:</span> <span class="mh">0x01</span><span class="p">,</span>
    <span class="s2">"IEEE_802"</span><span class="p">:</span> <span class="mh">0x06</span><span class="p">,</span>
    <span class="s2">"ARCNET"</span><span class="p">:</span> <span class="mh">0x07</span><span class="p">,</span>
    <span class="s2">"FRAME_RELAY"</span><span class="p">:</span> <span class="mh">0xf</span><span class="p">,</span>
    <span class="s2">"ATM"</span><span class="p">:</span> <span class="mh">0x10</span><span class="p">,</span>
    <span class="s2">"SERIAL"</span><span class="p">:</span> <span class="mh">0x14</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">bcolors</span><span class="p">:</span>
    <span class="n">CRED</span>    <span class="o">=</span> <span class="s1">'</span><span class="se">\33</span><span class="s1">[31m'</span>
    <span class="n">CGREEN</span>  <span class="o">=</span> <span class="s1">'</span><span class="se">\33</span><span class="s1">[32m'</span>
    <span class="n">CYELLOW</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\33</span><span class="s1">[33m'</span>
    <span class="n">CBLUE</span>   <span class="o">=</span> <span class="s1">'</span><span class="se">\33</span><span class="s1">[34m'</span>
    <span class="n">CBEIGE</span>  <span class="o">=</span> <span class="s1">'</span><span class="se">\33</span><span class="s1">[36m'</span>
    <span class="n">CBEIGE2</span>  <span class="o">=</span> <span class="s1">'</span><span class="se">\33</span><span class="s1">[96m'</span>
    <span class="n">OKBLUE</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[94m'</span>
    <span class="n">ENDC</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[0m'</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\033</span><span class="s1">[1m'</span>

<span class="k">def</span> <span class="nf">green</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">CGREEN</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">ENDC</span>

<span class="k">def</span> <span class="nf">blue</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">CBLUE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">ENDC</span>

<span class="k">def</span> <span class="nf">blue2</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">OKBLUE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">ENDC</span>

<span class="k">def</span> <span class="nf">blue3</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">CBEIGE2</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">ENDC</span>

<span class="k">def</span> <span class="nf">blue4</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">CBEIGE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">ENDC</span>

<span class="k">def</span> <span class="nf">red</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">CRED</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcolors</span><span class="o">.</span><span class="n">ENDC</span>

<span class="k">def</span> <span class="nf">mac_to_str</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">octets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">octets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">'02x'</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">"-"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">octets</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ipv4_to_str</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">octets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">octets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">"."</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">octets</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">str_to_mac</span><span class="p">(</span><span class="n">macstr</span><span class="p">):</span>
    <span class="n">mac_as_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">macstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mac_as_bytes</span>

<span class="k">def</span> <span class="nf">str_to_ipv4</span><span class="p">(</span><span class="n">ipstr</span><span class="p">):</span>
    <span class="n">ip_as_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ipstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">ip_as_bytes</span>

<span class="k">def</span> <span class="nf">unpack_ethernet_frame</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
    <span class="n">DEST_MAC</span><span class="p">,</span> <span class="n">SRC_MAC</span><span class="p">,</span> <span class="n">ETHER_TYPE</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'! 6s 6s H'</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[:</span><span class="mi">14</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">EthernetFrame</span><span class="p">(</span><span class="n">dest_mac</span><span class="o">=</span><span class="n">DEST_MAC</span><span class="p">,</span> <span class="n">src_mac</span><span class="o">=</span><span class="n">SRC_MAC</span><span class="p">,</span> <span class="n">ether_type</span><span class="o">=</span><span class="n">ETHER_TYPE</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">14</span><span class="p">:])</span>

<span class="k">def</span> <span class="nf">pack_ethernet_frame</span><span class="p">(</span><span class="n">ethernet_frame</span><span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'! 6s 6s H'</span><span class="p">,</span> <span class="n">ethernet_frame</span><span class="o">.</span><span class="n">DESTINATION</span><span class="p">,</span> <span class="n">ethernet_frame</span><span class="o">.</span><span class="n">SOURCE</span><span class="p">,</span> <span class="n">ethernet_frame</span><span class="o">.</span><span class="n">ETHER_TYPE</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">ethernet_frame</span><span class="o">.</span><span class="n">PAYLOAD</span>
    <span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="n">payload</span>

<span class="k">def</span> <span class="nf">unpack_arp_message</span><span class="p">(</span><span class="n">raw_data</span><span class="p">):</span>
    <span class="n">HTYPE</span><span class="p">,</span> <span class="n">PTYPE</span><span class="p">,</span> <span class="n">HLEN</span><span class="p">,</span> <span class="n">PLEN</span><span class="p">,</span> <span class="n">OPER</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'! H H B B H'</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">SHA</span><span class="p">,</span> <span class="n">SPA</span><span class="p">,</span> <span class="n">THA</span><span class="p">,</span> <span class="n">TPA</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">'! 6s 4s 6s 4s'</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">28</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ARPMessage</span><span class="p">(</span><span class="n">htype</span><span class="o">=</span><span class="n">HTYPE</span><span class="p">,</span> <span class="n">ptype</span><span class="o">=</span><span class="n">PTYPE</span><span class="p">,</span> <span class="n">hlen</span><span class="o">=</span><span class="n">HLEN</span><span class="p">,</span> <span class="n">plen</span><span class="o">=</span><span class="n">PLEN</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">OPER</span><span class="p">,</span> <span class="n">sha</span><span class="o">=</span><span class="n">SHA</span><span class="p">,</span> <span class="n">spa</span><span class="o">=</span><span class="n">SPA</span><span class="p">,</span> <span class="n">tha</span><span class="o">=</span><span class="n">THA</span><span class="p">,</span> <span class="n">tpa</span><span class="o">=</span><span class="n">TPA</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pack_arp_message</span><span class="p">(</span><span class="n">arp_message</span><span class="p">):</span>

    <span class="k">if</span><span class="p">(</span><span class="n">arp_message</span><span class="o">.</span><span class="n">HLEN</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Only supporting HLEN = 6 (MAC)"</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="n">arp_message</span><span class="o">.</span><span class="n">PLEN</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Only support PLEN = 4 (Ipv4)"</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'! H H B B H'</span><span class="p">,</span> <span class="n">arp_message</span><span class="o">.</span><span class="n">HTYPE</span><span class="p">,</span> <span class="n">arp_message</span><span class="o">.</span><span class="n">PTYPE</span><span class="p">,</span> <span class="n">arp_message</span><span class="o">.</span><span class="n">HLEN</span><span class="p">,</span> <span class="n">arp_message</span><span class="o">.</span><span class="n">PLEN</span><span class="p">,</span> <span class="n">arp_message</span><span class="o">.</span><span class="n">OPER</span><span class="p">)</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">'! 6s 4s 6s 4s'</span><span class="p">,</span> <span class="n">arp_message</span><span class="o">.</span><span class="n">SHA</span><span class="p">,</span> <span class="n">arp_message</span><span class="o">.</span><span class="n">SPA</span><span class="p">,</span> <span class="n">arp_message</span><span class="o">.</span><span class="n">THA</span><span class="p">,</span> <span class="n">arp_message</span><span class="o">.</span><span class="n">TPA</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="n">addresses</span>

<span class="k">class</span> <span class="nc">EthernetFrame</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_mac</span><span class="p">,</span> <span class="n">src_mac</span><span class="p">,</span> <span class="n">ether_type</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DESTINATION</span> <span class="o">=</span> <span class="n">dest_mac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SOURCE</span> <span class="o">=</span> <span class="n">src_mac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ETHER_TYPE</span> <span class="o">=</span> <span class="n">ether_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PAYLOAD</span> <span class="o">=</span> <span class="n">payload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LOG_TIME</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ether</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ETHER_TYPE</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="s2">"UNKNOWN"</span>

        <span class="c1"># Translate EtherType to human readable text</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ETHER_TYPE</span> <span class="ow">in</span> <span class="n">ETHER_TYPE_DICT</span><span class="p">:</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">ETHER_TYPE_DICT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ETHER_TYPE</span><span class="p">]</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">mac_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SOURCE</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">mac_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DESTINATION</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PAYLOAD</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"[ Ethernet - </span><span class="si">{</span><span class="n">ether</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">trans</span><span class="si">}</span><span class="s2">; Source: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">; Dest: </span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">; Len: </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">; Logtime: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LOG_TIME</span><span class="p">)</span><span class="si">}</span><span class="s2"> ]"</span>

<span class="k">class</span> <span class="nc">ARPMessage</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">htype</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">hlen</span><span class="p">,</span> <span class="n">plen</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">sha</span><span class="p">,</span> <span class="n">spa</span><span class="p">,</span> <span class="n">tha</span><span class="p">,</span> <span class="n">tpa</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HTYPE</span> <span class="o">=</span> <span class="n">htype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PTYPE</span> <span class="o">=</span> <span class="n">ptype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HLEN</span> <span class="o">=</span> <span class="n">hlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PLEN</span> <span class="o">=</span> <span class="n">plen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OPER</span> <span class="o">=</span> <span class="n">operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SHA</span> <span class="o">=</span> <span class="n">sha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SPA</span> <span class="o">=</span> <span class="n">spa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">THA</span> <span class="o">=</span> <span class="n">tha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TPA</span> <span class="o">=</span> <span class="n">tpa</span>

    <span class="k">def</span> <span class="nf">arp_operation_to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPER</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"REQUEST"</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPER</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"REPLY"</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Unknown ARP operation"</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="s2">" "</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">"-"</span> <span class="o">*</span> <span class="mi">44</span>

        <span class="n">arp_str</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">arp_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">"| "</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">" |</span><span class="se">\n</span><span class="s2">"</span>
        <span class="n">arp_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">"| </span><span class="si">{:&lt;44}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ARP </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">arp_operation_to_str</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">arp_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">"| "</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">" |</span><span class="se">\n</span><span class="s2">"</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span> <span class="sa">f</span><span class="s2">"HTYPE </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HTYPE</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"PTYPE </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PTYPE</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span> <span class="p">),</span>
            <span class="p">(</span> <span class="sa">f</span><span class="s2">"HLEN  </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HLEN</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"PLEN  </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PLEN</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span> <span class="p">),</span>
            <span class="p">(</span> <span class="sa">f</span><span class="s2">"SHA </span><span class="si">{</span><span class="n">mac_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SHA</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"SPA </span><span class="si">{</span><span class="n">ipv4_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SPA</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span> <span class="p">),</span>
            <span class="p">(</span> <span class="sa">f</span><span class="s2">"THA </span><span class="si">{</span><span class="n">mac_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">THA</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"TPA </span><span class="si">{</span><span class="n">ipv4_to_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TPA</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span> <span class="p">),</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">arp_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">"| </span><span class="si">{:&lt;22}</span><span class="s2"> | </span><span class="si">{:&lt;19}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

        <span class="n">arp_str</span> <span class="o">+=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">"| "</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">" |</span><span class="se">\n</span><span class="s2">"</span>
        <span class="k">return</span> <span class="n">arp_str</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># create raw ethernet socket</span>
    <span class="n">ETH_P_ALL</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_PACKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_ALL</span><span class="p">))</span>

    <span class="c1"># ARP LISTENER</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">raw_data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">65565</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">unpack_ethernet_frame</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>

        <span class="c1"># log ARP only</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">ETHER_TYPE</span> <span class="o">==</span> <span class="n">ETHER_TYPE_DICT_INVERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"ARP"</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">blue2</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>

            <span class="n">arp</span> <span class="o">=</span> <span class="n">unpack_arp_message</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">PAYLOAD</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">arp</span><span class="o">.</span><span class="n">OPER</span> <span class="o">==</span> <span class="n">ARP_OPERATION_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"REQUEST"</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="n">arp</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="n">arp</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Received interrupt. Exiting..."</span><span class="p">)</span>
</code></pre></div></div></div>
<p>This script will also serve as a library for other ARP scripts that will follow.</p>
<h2 id="arp-in-action">ARP in Action<a class="headerlink" href="#arp-in-action" title="Permanent link"> </a></h2>
<p>After starting the Gateway (pfSense) and Middleman (Kali Linux) we can observe ARP in action.</p>
<p>Start the ARP listener script as root on Middleman in one terminal:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>$ sudo python3 arpfun.py
</code></pre></div></div></div>
<p>Then open another terminal.</p>
<p>At first the ARP table of Middleman will be empty:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>$ arp -n
&lt;blank&gt;
</code></pre></div></div></div>
<p>If your ARP table already has entries, then you can empty it with:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>$ sudo ip -s -s neigh flush all

*** Round <span class="m">1</span>, deleting <span class="m">1</span> entries ***
*** Flush is <span class="nb">complete</span> after <span class="m">1</span> round ***

$ arp -n
&lt;blank&gt;
</code></pre></div></div></div>
<p>Now, when we try to send a ping to the Gateway the MAC address associated with the IPv4 address is not known, so ARP will have to be performed first:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>$ ping -c <span class="m">1</span> <span class="m">10</span>.0.0.111
PING <span class="m">10</span>.0.0.111 <span class="o">(</span><span class="m">10</span>.0.0.111<span class="o">)</span> <span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from <span class="m">10</span>.0.0.111: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">0</span>.753 ms
</code></pre></div></div></div>
<p>While the ping command runs we can observe the ARP handshake in the listener console:</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman's ARP Request to Gateway" src="/assets/img/00_middleman_basic_arp_to_gateway.png"/></div></div></p>
<p>After a successful handshake there will be an entry for Gateway in Middleman's ARP table:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>$ arp -n
Address                  HWtype  HWaddress           Flags Mask            Iface
<span class="m">10</span>.0.0.111               ether   <span class="m">08</span>:00:27:cc:cc:cc   C                     eth0
</code></pre></div></div></div>
<p>The Gateway (pfSense VM) will also update its ARP table based on the Request and add an entry for Middleman. So Gateway does not have to send an ARP Request to Middleman.</p>
<h2 id="arp-announcements-and-probes">ARP Announcements and Probes<a class="headerlink" href="#arp-announcements-and-probes" title="Permanent link"> </a></h2>
<h3 id="debians-announcements">Debian's Announcements<a class="headerlink" href="#debians-announcements" title="Permanent link"> </a></h3>
<p>Now we start the Alf VM (Debian Linux 11) while having the ARP listener still running on Middleman (Kali Linux). We will observe an ARP announcement from Alf during its startup.</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Alf's ARP Announcements" src="/assets/img/01_middleman_alf_started_arp_announcement.png"/></div></div></p>
<p>An <strong>ARP Announcement</strong> looks like a regular ARP Request directed at the broadcast MAC address <code>FF:FF:FF:FF:FF:FF</code>, but the source IPv4 address (SPA) will be the same as the target ipv4 address (TPA). So SPA = TPA. Depending on the implementation the source and target MAC address might also be the same, but that is not required.</p>
<p>Other hosts can <strong>take the two source addresses and update their ARP Tables</strong> accordingly. </p>
<p>No Reply to these Announcement Requests is expected. If a Reply is received, then this would indicate an <strong>IP Address conflict</strong>.</p>
<p>The other hosts in the network segment <em>can</em> use this Request to update their ARP table, but they can also choose to ignore it. Our Middleman Kali Linux chooses to ignore it.</p>
<p>Alf performs this Announcement Request three times. </p>
<p>Afterwards it performs a regular ARP Request to its configured Gateway (10.0.0.111).</p>
<p>We won't see the Reply from the Gateway because it will be a Unicast Ethernet frame directed directly at the source of the Request. Activating promiscuous mode on Middleman's network interface does not help here, because VirtualBox simulates a network switch between the three hosts. If the switch does its job correctly, then a unicast frame will not be sent to uninvolved hosts.</p>
<h3 id="windows-11s-announcements">Windows 11's Announcements<a class="headerlink" href="#windows-11s-announcements" title="Permanent link"> </a></h3>
<p>When we start Bert (Windows 11) we will also see ARP Announcements during startup. But we can also observe another variant of ARP:</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Bert's ARP Probes and Announcements" src="/assets/img/03_middleman_bert_arp_annoucement.png"/></div></div></p>
<p>The first kind has the SPA (IPv4 address) set to <code>0.0.0.0</code>, but otherwise looks like a regular ARP Announcement. This is called an <strong>ARP Probe</strong>. Because the source IPv4 address is set to all zeroes it is not intended to update the ARP entries of other hosts. It's purpose is merely to check whether there is already a host with the desired IPv4 address in the network. If a Reply is received, then this would indicate an IP address conflict. If no Replies are received, then the address is assumed to be available.</p>
<p>The second kind is once again a regular ARP Announcement with <code>SPA = TPA</code>, both fields set to the interface IPv4 address (here <code>10.0.0.2</code>). Just like Alf's ARP Announcements.</p>
<p>Just like Alf, Bert will also send ARP requests to the configured gateway for its network interface as part of the setup during startup. </p>
<h2 id="arp-table-update-behavior">ARP Table Update Behavior<a class="headerlink" href="#arp-table-update-behavior" title="Permanent link"> </a></h2>
<p>Like I mentioned before, not all implementations of ARP behave the same way when it comes to updating the ARP table.</p>
<p>The examples below assume the default configuration for the given OS on a fresh VM. Besides the default behavior you can influence the ARP update behavior (and you should do so in a hardened network environment) via configuration in almost all operating systems.</p>
<p>I hacked together an ARP sender using the code we already have used as a library:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># 0A75</span>
<span class="c1"># arp_sender.py</span>
<span class="kn">from</span> <span class="nn">arpfun</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># ARP Sender</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">red</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">32</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">red</span><span class="p">(</span><span class="s2">"   Hacky Insecure ARP Sender"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">red</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">32</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="s2">"[*] MAC format: ff-ff-ff-ff-ff-ff or ff:ff:ff:ff:ff:ff"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="s2">"[*] IPv4 format: 255.255.255.255"</span><span class="p">))</span>

            <span class="n">interface_name</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="s2">"[?] What interface do you want to use? (default: eth0) &gt; "</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">"eth0"</span>

            <span class="n">ethernet_local_mac</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="s2">"[?] ETHERNET Source MAC address? &gt; "</span><span class="p">))</span>
            <span class="n">ethernet_local_mac</span> <span class="o">=</span> <span class="n">ethernet_local_mac</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">)</span>
            <span class="n">ethernet_local_mac_raw</span> <span class="o">=</span> <span class="n">str_to_mac</span><span class="p">(</span><span class="n">ethernet_local_mac</span><span class="p">)</span>

            <span class="n">ethernet_target_mac</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="s2">"[?] ETHERNET Target MAC address? &gt; "</span><span class="p">))</span>
            <span class="n">ethernet_target_mac</span> <span class="o">=</span> <span class="n">ethernet_target_mac</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">)</span>
            <span class="n">ethernet_target_mac_raw</span> <span class="o">=</span> <span class="n">str_to_mac</span><span class="p">(</span><span class="n">ethernet_target_mac</span><span class="p">)</span>

            <span class="n">arp_local_mac</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[?] ARP Sender MAC address? (</span><span class="si">{</span><span class="n">ethernet_local_mac</span><span class="si">}</span><span class="s2">) [enter to confirm] &gt; "</span><span class="p">))</span> <span class="ow">or</span> <span class="n">ethernet_local_mac</span>
            <span class="n">arp_local_mac</span> <span class="o">=</span> <span class="n">arp_local_mac</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">)</span>
            <span class="n">arp_local_mac_raw</span> <span class="o">=</span> <span class="n">str_to_mac</span><span class="p">(</span><span class="n">arp_local_mac</span><span class="p">)</span>

            <span class="n">arp_target_mac</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[?] ARP Target MAC address? (</span><span class="si">{</span><span class="n">ethernet_target_mac</span><span class="si">}</span><span class="s2">) [enter to confirm] &gt; "</span><span class="p">))</span> <span class="ow">or</span> <span class="n">ethernet_target_mac</span>
            <span class="n">arp_target_mac</span> <span class="o">=</span> <span class="n">arp_target_mac</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">)</span>
            <span class="n">arp_target_mac_raw</span> <span class="o">=</span> <span class="n">str_to_mac</span><span class="p">(</span><span class="n">arp_target_mac</span><span class="p">)</span>

            <span class="n">arp_local_ip</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[?] ARP Sender Ipv4 address? &gt; "</span><span class="p">))</span>
            <span class="n">arp_local_ip_raw</span> <span class="o">=</span> <span class="n">str_to_ipv4</span><span class="p">(</span><span class="n">arp_local_ip</span><span class="p">)</span>

            <span class="n">arp_target_ip</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[?] ARP Target Ipv4 address? &gt; "</span><span class="p">))</span>
            <span class="n">arp_target_ip_raw</span> <span class="o">=</span> <span class="n">str_to_ipv4</span><span class="p">(</span><span class="n">arp_target_ip</span><span class="p">)</span>

            <span class="n">arp_operation</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="s2">"[?] ARP Operation? [1 = REQUEST; 2 = REPLY] &gt; "</span><span class="p">))</span>
            <span class="n">arp_operation_raw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">arp_operation</span><span class="p">)</span>

            <span class="n">arp_message</span> <span class="o">=</span> <span class="n">ARPMessage</span><span class="p">(</span>
                <span class="mh">0x1</span><span class="p">,</span> 
                <span class="mh">0x800</span><span class="p">,</span> 
                <span class="mh">0x6</span><span class="p">,</span> 
                <span class="mh">0x4</span><span class="p">,</span> 
                <span class="n">arp_operation_raw</span><span class="p">,</span> 
                <span class="n">arp_local_mac_raw</span><span class="p">,</span> 
                <span class="n">arp_local_ip_raw</span><span class="p">,</span>
                <span class="n">arp_target_mac_raw</span><span class="p">,</span>
                <span class="n">arp_target_ip_raw</span>
                <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="s2">"[*] ARP Message:"</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">arp_message</span><span class="p">)</span>

            <span class="n">arp_raw</span> <span class="o">=</span> <span class="n">pack_arp_message</span><span class="p">(</span><span class="n">arp_message</span><span class="p">)</span>

            <span class="n">ethernet_frame</span> <span class="o">=</span> <span class="n">EthernetFrame</span><span class="p">(</span>
                <span class="n">ethernet_target_mac_raw</span><span class="p">,</span> 
                <span class="n">ethernet_local_mac_raw</span><span class="p">,</span>
                <span class="n">ETHER_TYPE_DICT_INVERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"ARP"</span><span class="p">),</span>
                <span class="n">arp_raw</span>
                <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="s2">"[*] Ethernet Header:"</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ethernet_frame</span><span class="p">)</span>

            <span class="n">ethernet_frame_raw</span> <span class="o">=</span> <span class="n">pack_ethernet_frame</span><span class="p">(</span><span class="n">ethernet_frame</span><span class="p">)</span>

            <span class="n">confirm</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">blue4</span><span class="p">(</span><span class="s2">"[?] SEND? [ y ] &gt; "</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">confirm</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"y"</span><span class="p">):</span>
                <span class="n">ETH_P_ALL</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_PACKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_ALL</span><span class="p">))</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span> <span class="n">interface_name</span><span class="p">,</span> <span class="mi">0</span> <span class="p">))</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">ethernet_frame_raw</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">blue3</span><span class="p">(</span><span class="s2">"[+] Your frame has been sent!"</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">red</span><span class="p">(</span><span class="s2">"[-] Aborted!"</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Error:"</span><span class="p">,</span> <span class="n">red</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Received interrupt. Exiting..."</span><span class="p">)</span>
</code></pre></div></div></div>
<h3 id="alf-debian-11s-update-behavior">Alf - Debian 11's Update Behavior<a class="headerlink" href="#alf-debian-11s-update-behavior" title="Permanent link"> </a></h3>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman's unsolicited ARP Reply" src="/assets/img/04_00_unsolicited_reply_toalf.png"/></div></div></p>
<p>Alf will ignore unsolicited ARP Replies when it comes to updating its table. </p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman's unsolicited ARP Reply" src="/assets/img/04_01_unsolicited_reply_toalf.png"/></div></div></p>
<p>Alf (Debian) does not care for unsolicited Replies.</p>
<p>On the other hand, when we send a direct unicast ARP Request to Alf, then Alf will update its table and send a direct unicast Reply as expected. So an Ethernet broadcast is not required for the Request part of the handshake.</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman updates Alf's table" src="/assets/img/05_direct_arp_toalf_update.png"/></div></div></p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman updates Alf's table" src="/assets/img/05b_direct_arp_toalf_update.png"/></div></div></p>
<p>We can also use this behavior to trick Alf into replacing existing entries like the one for the Gateway <code>10.0.0.111</code>:</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman updates Alf's table" src="/assets/img/06_00_bamboozle_alf.png"/></div></div></p>
<p>We can observe the MAC address for <code>10.0.0.111</code> being updated from the Gateway MAC address to the MAC address of Middleman:</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman updates Alf's table" src="/assets/img/06_01_bamboozle_alf.png"/></div></div></p>
<p>But Alf will quickly notice that this entry is bogus when our Middleman host does not actually respond to network traffic as expected: </p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman updates Alf's table" src="/assets/img/06_02_bamboozle_alf.png"/></div></div></p>
<p>If we want to spoof Alf permanently, then we will have to respond to its own ARP Requests and relay Ethernet traffic to the intended target (or make up appropriate responses).</p>
<p>But more about ARP spoofing in the next part of this series</p>
<h3 id="bert-windows-11s-update-behavior">Bert - Windows 11's Update Behavior<a class="headerlink" href="#bert-windows-11s-update-behavior" title="Permanent link"> </a></h3>
<p>Bert (Win11) also ignores unsolicited ARP Replies.</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman unsolicited ARP Reply" src="/assets/img/07_00_unsolicited_reply_tobert.png"/></div></div></p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman unsolicited ARP Reply" src="/assets/img/07_01_unsolicited_reply_tobert.png"/></div></div></p>
<p>But updating Bert's ARP table with a Request also works the same way as with Alf.</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman updates Bert's table" src="/assets/img/08_00_direct_arp_tobert_update.png"/></div></div></p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman updates Bert's table" src="/assets/img/08_01_direct_arp_tobert_update.png"/></div></div></p>
<p>Tricking Bert also works exactly the same way as with Alf:</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman tricks Bert" src="/assets/img/09_00_bamboozle_bert.png"/></div></div></p>
<p>Because Bert already knows Middleman, you will see two entries with the same MAC address:</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman tricks Bert" src="/assets/img/09_01_bamboozle_bert.png"/></div></div></p>
<p>Just like Alf, Bert will quickly notice that this entry is bogus though, if we do not keep up the charade. It will re-establish the correct entry for Gateway with ARP eventually.</p>
<h3 id="freebsd-pfsense-gateway">FreeBSD - pfSense Gateway<a class="headerlink" href="#freebsd-pfsense-gateway" title="Permanent link"> </a></h3>
<p>Unlike Windows 11 and Debian Linux, the pfSense Gateway will update its ARP table when you send an unsolicited ARP Reply:</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman sends unsolicited Reply to Gateway" src="/assets/img/10_unsolicited_gateway.png"/></div></div></p>
<p>Gateway adds an entry based on the Reply:</p>
<p><div class="breaker breaker-image"><div class="repairman"><img alt="Middleman sends unsolicited Reply to Gateway" src="/assets/img/11_unsolicited_gateway_censored.png"/></div></div></p>
<p>Otherwise this VM also behaves like Alf and Bert. A Request updates its table.</p>
<h2 id="reference-commands-for-testing-with-arp">Reference: Commands for testing with ARP<a class="headerlink" href="#reference-commands-for-testing-with-arp" title="Permanent link"> </a></h2>
<p><strong>Note:</strong> You will have to run most of these as root / Administrator.</p>
<h3 id="linux">Linux:<a class="headerlink" href="#linux" title="Permanent link"> </a></h3>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code><span class="c1"># Print current ARP table</span>
/usr/sbin/arp -n

<span class="c1"># set interface to promiscuous mode</span>
ip link <span class="nb">set</span> eth0 promisc on

<span class="c1"># turn off automatic ARP for a given interface (this also clears ARP table)</span>
<span class="c1"># WARNING: this effectively makes it impossible for your host to communicate in the LAN until you turn it back on</span>
ip link <span class="nb">set</span> dev eth0 arp off

<span class="c1"># turn automatic ARP back on</span>
ip link <span class="nb">set</span> dev eth0 arp on

<span class="c1"># clear ARP table</span>
ip -s -s neigh flush all
</code></pre></div></div></div>
<h3 id="windows">Windows:<a class="headerlink" href="#windows" title="Permanent link"> </a></h3>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code><span class="c1"># Print current ARP table</span>
arp -a

<span class="c1"># Clear ARP table</span>
arp -d
</code></pre></div></div></div>
<h3 id="arping">arping<a class="headerlink" href="#arping" title="Permanent link"> </a></h3>
<p>You can manually send ARP messages with the <code>arping</code> utility (<a href="https://www.man7.org/linux/man-pages/man8/arping.8.html">man page</a>).</p>
<p>It can be used similarly to the regular <code>ping</code> to verify connectivity between two hosts, just on layer 2 rather than layer 3.</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>arping <span class="o">[</span>-AbDfhqUV<span class="o">]</span> <span class="o">[</span>-c count<span class="o">]</span> <span class="o">[</span>-w deadline<span class="o">]</span> <span class="o">[</span>-i interval<span class="o">]</span>
              <span class="o">[</span>-s source<span class="o">]</span> <span class="o">[</span>-I interface<span class="o">]</span> <span class="o">{</span>destination<span class="o">}</span>
</code></pre></div></div></div>
<p>You will have to run this command as root.</p>
<p>Noteworthy are the parameters:</p>
<div class="breaker"><div class="repairman"><div class="highlight"><pre><span></span><code>-A
           The same as -U, but ARP REPLY packets used instead of ARP
           REQUEST.

-f
           Finish after the first reply confirming that target is alive

-U
           Unsolicited ARP mode to update neighbours ARP caches. No
           replies are expected.

-s <span class="nb">source</span>
           IP <span class="nb">source</span> address to use in ARP packets.
</code></pre></div></div></div>
<p>So the tool can also be used to manipulate ARP entries on other hosts. But this ability is somewhat limited. For example it won't allow you to pretend to be a different MAC Address (in the frame) than your interface default (without some hacking).</p>
<h2 id="reference-arp-terminology-glossary">Reference: ARP Terminology Glossary<a class="headerlink" href="#reference-arp-terminology-glossary" title="Permanent link"> </a></h2>
<ul>
<li><strong>ARP</strong> - <strong>Address Resolution Protocol</strong>. Translates logical addresses to hardware addresses in a local network. Most commonly used to figure out the MAC Address associated with an IPv4 Address in an Ethernet network segment.</li>
<li><strong>ARP Annoucement</strong> - A broadcast ARP Request that is used to annouce an IP address change to the network. A Reply is not expected and would indicate an IP address conflict.</li>
<li><strong>ARP cache poisoining</strong> - See "ARP Spoofing"</li>
<li><strong>ARP Probe</strong> - A broadcast ARP Request that is used to check whether an IP address is already in use. A Reply would indicate an IP address conflict.</li>
<li><strong>ARP Spoofing</strong> - A <a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">Man-in-the-Middle attack</a> in which a hostile actor pretends to be another host by updating the ARP table of one or more other hosts. For example this can be used to read unencrypted traffic, exploit trust relationships or denial of service (DoS).</li>
<li><strong>ARP Table</strong> - A data structure that maintains dynamic (discovered) and static ARP entries on a host. An entry contains the MAC Address and IPv4 address associated with a neighboring host. Also sometimes referred to as "ARP Cache".</li>
<li><strong>Gratuitous ARP</strong> - An ARP Request/Reply that is not normally needed according to the ARP specification (<a href="https://datatracker.ietf.org/doc/html/rfc826">RFC 826</a>). Examples are unsolicited ARP Replies, ARP Probes or ARP Annoucements. See also: <a href="https://datatracker.ietf.org/doc/html/rfc5227">RFC 5227</a>.</li>
<li><strong>NDP</strong> - <strong>Neighbor Discovery Protocol</strong>. Alternative protocol to ARP. Commonly used with IPv6.</li>
<li><strong>Unsolicited ARP Reply</strong> - An ARP Reply sent to a host without a prior Request from that host. Usually for the purpose of updating the ARP table of that host.</li>
</ul>
                    <div class="article-meta">
                        <section class="article-share-section">
                            <a href="https://twitter.com/intent/tweet?text=Fun%20with%20ARP%20-%20A%20Look%20at%20the%20Protocol%20https%3A%2F%2Fsecoats.github.io%2Fposts%2Farp_0_protocol.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>
                            <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fsecoats.github.io%2Fposts%2Farp_0_protocol.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>
                            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fsecoats.github.io%2Fposts%2Farp_0_protocol.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
                          </section>
                        <section class="article-meta-section">
                            <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
                            <span itemprop="keywords">
                                <a href="/tags.html#network" class="article-tag" rel="tag">network</a><span class="sep"> </span>
                                <a href="/tags.html#protocol" class="article-tag" rel="tag">protocol</a><span class="sep"> </span>
                                <a href="/tags.html#overview" class="article-tag" rel="tag">overview</a><span class="sep"> </span>
                            </span>
                        </section>
                        <section class="article-meta-section">
                            <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
                            <span itemprop="keywords">
                                <a href="/categories.html#tutorial" class="article-tag" rel="tag">tutorial</a>
                                <a href="/categories.html#programming" class="article-tag" rel="tag">programming</a>
                            </span>
                        </section>
                        <section class="article-meta-section">
                            <span style="margin-right:1em;"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Published:</strong> <time datetime="2022-01-24 16:00:00">January 24, 2022</time></span>
                    
                        </section> 
                        <section class="article-meta-section">
                            
                            <span><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Last Updated:</strong> <time datetime="2022-01-27 16:00:00">January 27, 2022</time></span>
                        </section>
                    </div>
                </article>
            </main>
            <div id="footerbar">
                <footer class="wrapper">
                    <div class="footer-info">
                        <ul class="social-icons">
    <li><a href="https://github.com/secoats" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    <!--<li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>-->
    <li><a href="https://twitter.com/cybercereals" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> Twitter</a></li>
</ul>
<div class="copyright-notice">© 2021 secoats</div>
                    </div>
                </footer>
            </div>
        </div>
        <script src="/assets/js/main.js"></script>
    </body>
</html>